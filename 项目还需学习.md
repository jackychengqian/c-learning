gyodurrtvlxddihd

**æ•´ä¸ªé¡¹ç›®æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼ˆä»éœ€æ±‚åˆ°æŠ€æœ¯é€‰å‹ï¼‰ã€å¦‚æœä»å•ä½“æ”¹æˆå¾®æœåŠ¡æ‰“ç®—æ€ä¹ˆæ”¹**

**çŸ¥é“è¿™ä¸ªé¡¹ç›®ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿæ€§èƒ½ç“¶é¢ˆç‚¹ç‚¹å‘ç”Ÿåœ¨ä»€ä¹ˆï¼Ÿæ€ä¹ˆå»æ‹“å±•**

**ç”¨æˆ·ä¹‹é—´çš„æ¶ˆæ¯ä¼ è¾“æ˜¯ä½¿ç”¨çš„ä»€ä¹ˆ**

## **é¡¹ç›®æ³¨é‡æ€ä¹ˆä¼˜åŒ–çš„** é¡¹ç›®ä¸Šçº¿

**GateServer ç”¨TCPç›´æ¥åšé•¿è¿æ¥é€šä¿¡ æˆ– ä½¿ç”¨WebSocket**

**mysqlè¡¨æ€ä¹ˆè®¾è®¡çš„**

**nginxæ­£åå‘ä»£ç†**

**æ€ä¹ˆåˆ†åº“åˆ†è¡¨çš„ ä¾æ®**

**è¿™éƒ¨åˆ†çš„åˆ†åº“åˆ†è¡¨æ€ä¹ˆåšçš„ï¼Ÿé€‰çš„ä»€ä¹ˆåšåˆ†ç‰‡é”®ï¼Ÿé€‰çš„ä»€ä¹ˆåˆ†ç‰‡ç®—æ³•**

# ç›®å‰è¯¥çœ‹

# 1.rpc    rpcåè®®æœ‰å‡ å±‚       grpcä¸»è¦é—®é¢˜åº•å±‚åŸç†  é—®ä»€ä¹ˆå¿«  ç”¨ä»€ä¹ˆä¼ è¾“ä¸é€šä¿¡åè®®  è·¨è¯­è¨€  grpcä¸httpåŒºåˆ«å¥½å¤„  grpcå®‰å…¨æ€§ è´Ÿè½½å‡è¡¡ é‡è¯•ç­–ç•¥ï¼Ÿ grpcå¼‚æ­¥ä½¿ç”¨æ–¹å¼æ‰‹å†™  proto2å’Œproto3åŒºåˆ«  grpcå’Œå…¶ä»–rpcæ¯”è¾ƒ  ç»“åˆé¡¹ç›®

# httpé•¿è¿æ¥ çŸ­è¿æ¥  åº•å±‚  grpcè¿æ¥æ± 

# 2.ASIO  éå¸¸é‡è¦  ä¸»è¦é—®é¢˜åº•å±‚åŸç† åŒæ­¥å’Œå¼‚æ­¥io  ioæ¨¡å‹  æ•°æ®å¤„ç†çš„è°ƒåº¦æ–¹æ¡ˆ å’Œå…¶ä»–ç½‘ç»œåº“æ¯”è¾ƒ  å“ªäº›åœºæ™¯é€‚åˆ  å¦‚ä½•å®ç°è·¨å¹³å°  ç»“åˆé¡¹ç›®

# 3.protobufå’Œjsonä½¿ç”¨å¯¹æ¯” ç¼ºç‚¹ä¸ä¼˜ç‚¹ ç¼–ç è§£ç  æ€ä¹ˆå‹ç¼© é‚£äº›å¯ä»¥å‹ç¼©(int?æµ®ç‚¹ï¼Ÿ)   protobufå“ªäº›ç»“æ„å¥½  å¯¹æ•°æ®ä¼ è¾“æœ‰å¸®åŠ©  è§£ææ—¶å¤„ç†é”™è¯¯ ä¼˜åŒ–æ€§èƒ½ åºåˆ—åŒ–ååºåˆ—åŒ–åº•å±‚åŸç†  å¤§ç«¯å°ç«¯æ¦‚å¿µä¸åˆ¤æ–­  åº•å±‚æ•°æ®æ ¼å¼(äºŒè¿›åˆ¶æ ¼å¼ å­—æ®µæ ‡è¯† é•¿åº¦å‰ç¼€ç­‰ç­‰) æ•°æ®ç»“æ„å‘é€å˜åŠ¨å¦‚ä½•ç»´æŠ¤  è¿˜æœ‰å“ªäº›åºåˆ—åŒ–åè®® å¦‚ä½•è§£æå‰ç«¯ä¼ æ¥çš„json   jsonè§£æå™¨   ç»“åˆé¡¹ç›®



# é¡¹ç›®å¸¸é—®é—®é¢˜

**ä¸€èˆ¬å°±æ˜¯è®©ä½ ä»‹ç»ä¸‹é¡¹ç›®æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œç”¨äº†ä»€ä¹ˆæŠ€æœ¯æ ˆï¼Œæ¯ä¸ªæŠ€æœ¯æ ˆéƒ½èµ·åˆ°ä»€ä¹ˆä½œç”¨ï¼Œé¡¹ç›®å¼€å‘æœŸé—´é‡åˆ°äº†ä»€ä¹ˆéš¾é¢˜ï¼Œæ€ä¹ˆè§£å†³çš„ï¼Œéš¾é¢˜è§£å†³/ä¼˜åŒ–åæ€§èƒ½æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œä¸­é—´å¯èƒ½ä¼šç©¿æ’ä¸€äº›ä¸šåŠ¡é—®é¢˜å’Œå…«è‚¡**

æ•°æ®åº“æ€ä¹ˆè®¾è®¡çš„ï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿå“ªäº›å»ºç«‹ç´¢å¼•ï¼Ÿä¸ºä»€ä¹ˆè¦åˆ†åº“åˆ†è¡¨ï¼ŸæŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨joinï¼ŸçŸ¥é“joinçš„æ€§èƒ½æŸå¤±å—ï¼ŒçŸ¥é“MySQLæ‰‡å‡ºçš„æ¦‚å¿µå—ï¼ŸRedisç”¨åœ¨å“ªé‡Œï¼Ÿç¼“å­˜åŒæ­¥æ€ä¹ˆåšçš„ï¼Ÿå¹¶å‘é‡å¤šå°‘ï¼ŒRediså¯èƒ½å•ç‚¹æ•…éšœå—ï¼ŸçŸ¥é“é›†ç¾¤å—ï¼Ÿ

çœ‹ä½ ç”¨åˆ°äº†å“ªäº›æŠ€æœ¯ ï¼Ÿ redis ç¼“å­˜è®¾è®¡ï¼Ÿ åˆ†å¸ƒå¼é”ï¼Ÿ mq åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯

æˆ‘éƒ½æ˜¯ç›´æ¥è¯´å­¦ä¹ é¡¹ç›®ï¼Œä½†æ˜¯ä½ è¦è¯´æ˜ä¸ºä»€ä¹ˆè¦åšï¼Œæ€ä¹ˆå­¦åšï¼ˆå¯ä»¥å¤¸å¼ ä¸€ç‚¹ï¼‰ï¼Œç„¶åå¼•å¯¼é¢è¯•å®˜é—®ç›¸å…³é—®é¢˜ï¼Œæ¯”å¦‚é»‘é©¬ç‚¹è¯„çƒ‚å¤§è¡—äº†ï¼Œä½ é¦–å…ˆè¯´å› ä¸ºredisåœ¨åç«¯å¼€å‘ä¸­çš„é‡è¦æ€§ï¼Œç„¶åç®€å•ä»‹ç»redisçš„ä½¿ç”¨åœºæ™¯ï¼Œç„¶åè¯´è‡ªå·±åšè¿™ä¸ªé¡¹ç›®çš„æ—¶å€™å‚è€ƒäº†å®˜æ–¹æ–‡æ¡£å’Œä¸€äº›ä¹¦ç±æ¯”å¦‚redisè®¾è®¡ä¸å¼€å‘ï¼Œç„¶åå¼•å¯¼é¢è¯•å®˜å»é—®redisçš„é—®é¢˜æˆ–è€…ä½ è‡ªå·±æå‡ºé¡¹ç›®çš„ç›¸å…³éš¾ç‚¹ï¼ˆå½“ç„¶è¿™ä¸ªä¸æ­¢æ˜¯é»‘é©¬è§†é¢‘é‡Œé‚£äº›é—®é¢˜ï¼‰ï¼Œå› ä¸ºåœ¨é¢è¯•è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡è®¾åœºæ™¯ï¼Œæ¯”å¦‚é”®å¤±æ•ˆä½†æ²¡æœ‰å®Œæˆä»»åŠ¡å’‹åŠï¼Œä½ ç¬¬ä¸€æ¬¡è§åˆ°é¢è¯•å®˜é—®è¿™ç§æ‹“å±•ï¼Œä¸‹æ¥å°±æŠŠè¿™ä¸ªæ‹“å±•å½“åšä½ çš„éš¾ç‚¹ç„¶åææ‡‚ğŸ˜‚ç„¶åä»‹ç»ç»™åˆ«çš„é¢è¯•å®˜ã€‚å½“ç„¶èƒ½è‡ªå·±ç‹¬ç«‹å¼€å‘ç„¶åä¸Šçº¿ä¹Ÿå¾ˆé‡è¦ï¼Œå°½åŠ›å¯ä»¥åšä¸€ä¸‹



1. é«˜qpsä¸‹è®¿é—®ï¼Œæ€ä¹ˆåŠ å¿«ç”¨æˆ·çš„æƒé™çš„åˆ¤æ–­é€Ÿç‡ï¼ˆåˆæ˜¯å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæˆ‘å‘ç°è¿™ä¸ªæ‹·é—®çš„é¢‘ç‡å¥½é«˜)
2. å¯¹äºæˆ‘çš„é¡¹ç›®ï¼ˆå¿«æ‰‹å®ä¹ æœŸé—´åšçš„ï¼‰ï¼Œæœ‰ä¸€ä¸ªredisï¼Œæœ¬åœ°ç¼“å­˜ï¼Œä¸‰çº§ç¼“å­˜ï¼Œè¿™ä¸‰è€…çš„æ•°æ®ä¸€è‡´æ€§æ€ä¹ˆåšçš„ï¼Œåœ¨æ•ˆç‡å’Œä¸€è‡´æ€§æ–¹é¢æ€ä¹ˆåšçš„å–èˆï¼ˆè¿™é‡Œç»“åˆä¸šåŠ¡è®²çš„ï¼‰ã€‚

# é˜»å¡æ€ä¹ˆåŠ  æ€§èƒ½æµ‹è¯• å‹åŠ›æµ‹è¯• è´Ÿè½½æµ‹è¯•qps

# å•ä¾‹æ¨¡å¼

## çœ‹åˆ«äººçš„åšå®¢

åœ¨è¿™ä¸ªé¡¹ç›®çš„å¼•å¯¼ä¸‹ï¼Œæ¥è§¦åˆ°äº†å¦‚ä½•ä½¿ç”¨grpcåè®®æ¥è¿›è¡ŒRPCè°ƒç”¨ï¼Œä¹‹ååˆå¯¹äºé¡¹ç›®è¿›è¡Œäº†ä¸€äº›å…¶ä»–çš„æ”¹é€ ï¼Œä¸»è¦çš„ä¾§é‡ç‚¹åœ¨äºå¯¹äºæœåŠ¡çš„åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œç„¶åæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªrpcåè®®æ¥è¿›è¡Œè°ƒç”¨

ä½†æ˜¯ä¸Šä¸€ä¸ªé¡¹ç›®å¹¶ä¸å®Œå–„ï¼Œåœ¨å¾ˆå¤šéƒ¨åˆ†éƒ½æœ‰å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹**ï¼Œæ¯”å¦‚æœåŠ¡æ³¨å†Œï¼ŒæœåŠ¡æ³¨å†Œï¼Œåœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼ŒæœåŠ¡å’ŒæœåŠ¡å¹¶ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ï¼Œåªæ˜¯ä»é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œç®€å•çš„è¯»å–ï¼Œç„¶åæ ¹æ®è¯»å–å‡ºçš„ipåœ°å€å’Œç«¯å£å·æ¥è¿›è¡Œè°ƒç”¨ï¼Œåæ¥éšç€å­¦ä¹ ï¼Œäº†è§£åˆ°äº†ä¸€äº›æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä¾‹å¦‚Zookeeperï¼ŒEctdè¿™äº›æœåŠ¡**

å› æ­¤åšäº†è¿™ä¸ªæ–°çš„é¡¹ç›®ï¼Œè¿™ä¸ªé¡¹ç›®ä¸»è¦æ˜¯å¯¹äºä¸Šä¸€ä¸ªé¡¹ç›®è¿›è¡Œä¸€ä¸ªè¿›é˜¶çš„è¡¥å……ï¼Œä¹Ÿåœ¨ä¸€äº›åœ°æ–¹è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚å¼•å…¥äº†elasticsearchè¿›è¡Œæ›´åŠ é«˜çº§çš„æ–‡æ¡£å­˜å‚¨å’Œæœç´¢çš„æœåŠ¡å™¨ï¼Œä»¥åŠODBè¿›è¡Œæ•°æ®åº“å¯¹è±¡çš„æ“ä½œç­‰ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªé¡¹ç›®æ¯”ä¸Šä¸€ä¸ªé¡¹ç›®æ›´åŠ è§„èŒƒï¼Œé€»è¾‘æ›´åŠ ç´§å¯†



grpcä¼šç­‰å¾…responseï¼Œå› æ­¤ä¼šé˜»å¡ï¼Œå¦‚æœæˆ‘è®¾è®¡rpcæ¡†æ¶ï¼Œæ€ä¹ˆé¿å…é˜»å¡ï¼Ÿå…¶å®ä¸ºæ¯ä¸ªgrpcè¯·æ±‚å¼€äº†goroutineä¸ä¼šé˜»å¡ä¸»è¿›ç¨‹ã€‚è¿™é‡Œåº”è¯¥æ˜¯æƒ³è€ƒioå¤šè·¯å¤ç”¨ï¼Œæ²¡ç­”

é‡æ–°çœ‹äº†ä¸€ä¸‹ç¾¤ä¸»çš„è§†é¢‘ï¼Œå¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªæ„æ€ï¼Œå¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªio_contextè°ƒç”¨runï¼Œé‚£ä¹ˆç»‘å®šåˆ°è¯¥æ³¨å†Œåˆ°è¯¥io_contextä¸Šçš„æ‰€æœ‰socketæœ‰äº‹ä»¶è¿”å›ï¼Œåœ¨ä»»æ„ä¸€ä¸ªçº¿ç¨‹ä¸­éƒ½å¯èƒ½å°±ç»ªï¼Œå› ä¸ºåº•å±‚ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚ä½†æ˜¯å¯èƒ½å¯¼è‡´åŒä¸€ä¸ªsocketä¸Šçš„æ³¨å†Œçš„ä¸¤ä¸ªäº‹ä»¶åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¢«å¤„ç†ï¼Œè¿™å°±ä¼šå¯èƒ½å¯¼è‡´ç«äº‰

lib_eventå¾ˆä¹…ä¹‹å‰çœ‹è¿‡ï¼Œæœ‰ç‚¹ä¸å¤ªè®°å¾—äº†ï¼Œå¤§æ¦‚ä¹Ÿå°±æ˜¯è°ƒç”¨waitï¼Œç„¶åæ‰€æœ‰å°±ç»ªäº‹ä»¶å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­å¾ªç¯å¤„ç†

io_context æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½ å¯ä»¥æŠŠå¤šä¸ªçº¿ç¨‹çš„ioäº‹ä»¶äº¤ç»™å®ƒï¼Œç„¶åå¦‚æœåº•å±‚å‘ç°è¯»å†™äº‹ä»¶å°±ç»ªäº†ï¼Œæ¯”å¦‚å¯¹ç«¯å‘é€æ•°æ®äº†ï¼Œio_contextä¸æ–­å¾ªç¯æ£€æµ‹ï¼Œå‘ç°æœ‰ä¸€ä¸ªioäº‹ä»¶å·²ç»å°±ç»ªäº†ï¼ˆå› ä¸ºå¯¹ç«¯å‘äº†ï¼Œæ‰€ä»¥å†…æ ¸ç¼“å†²åŒºæœ‰æ•°æ®äº†å¯è¯»ï¼‰ï¼Œå°±ä¼šå¸®ä½ è‡ªåŠ¨è°ƒç”¨ä½ åœ¨async_read ä¸­ä¼ é€’çš„å›è°ƒå‡½æ•°æ¥æ‰§è¡Œç›¸å…³é€»è¾‘ã€‚



![image-20250223170407171](C:\Users\86138\AppData\Roaming\Typora\typora-user-images\image-20250223170407171.png)







# é¡¹ç›®æ•´ä½“æµç¨‹ï¼š(æ€ä¹ˆå»ä»‹ç»è¿™ä¸ªé¡¹ç›®ï¼Ÿ)

1. GateServerä¸ºç½‘å…³æœåŠ¡ï¼Œä¸»è¦åº”å¯¹å®¢æˆ·ç«¯çš„è¿æ¥å’Œæ³¨å†Œè¯·æ±‚ï¼Œå› ä¸ºæœåŠ¡å™¨æ˜¯æ˜¯åˆ†å¸ƒå¼ï¼Œæ‰€ä»¥GateServeræ”¶åˆ°ç”¨æˆ·è¿æ¥è¯·æ±‚åä¼šæŸ¥è¯¢çŠ¶æ€æœåŠ¡é€‰æ‹©ä¸€ä¸ªè´Ÿè½½è¾ƒå°çš„Serveråœ°å€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ‹¿ç€è¿™ä¸ªåœ°å€ç›´æ¥å’ŒServeré€šä¿¡å»ºç«‹é•¿è¿æ¥ã€‚
2. å½“ç”¨æˆ·æ³¨å†Œæ—¶ä¼šå‘é€ç»™GateServer, GateServerè°ƒç”¨VarifyServeréªŒè¯æ³¨å†Œçš„åˆç†æ€§å¹¶å‘é€éªŒè¯ç ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ‹¿ç€è¿™ä¸ªéªŒè¯ç å»GateServeræ³¨å†Œå³å¯ã€‚
3. StatusServerï¼Œ ServerAï¼Œ ServerBéƒ½å¯ä»¥ç›´æ¥è®¿é—®Rediså’ŒMysqlæœåŠ¡ã€‚



![https://cdn.llfc.club/1709009717000.jpg](https://cdn.llfc.club/1709009717000.jpg)

## GateServeræœåŠ¡å™¨

ç½‘å…³æœåŠ¡å™¨ä¸»è¦åº”ç­”å®¢æˆ·ç«¯åŸºæœ¬çš„è¿æ¥è¯·æ±‚ï¼ŒåŒ…æ‹¬æ ¹æ®æœåŠ¡å™¨è´Ÿè½½æƒ…å†µé€‰æ‹©åˆé€‚æœåŠ¡å™¨ç»™å®¢æˆ·ç«¯ç™»å½•ï¼Œæ³¨å†Œï¼Œè·å–éªŒè¯æœåŠ¡ç­‰ï¼Œæ¥æ”¶httpè¯·æ±‚å¹¶åº”ç­”ã€‚

1. **Configç±»**  ç•¥

2. **CServerç±»**æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªç«¯å£å·ï¼Œåˆ›å»ºacceptoræ¥å—æ–°åˆ°æ¥çš„é“¾æ¥ã€‚

   CServerä¸»è¦åˆ©ç”¨Asioåˆ›å»ºä¸€ä¸ª**httpæœåŠ¡å™¨**ï¼ŒCServerçš„startå¼€å§‹ç›‘å¬_ acceptor.async_acceptï¼Œ æ”¶åˆ°é“¾æ¥åˆ›å»ºä¸€ä¸ªHpptConnectionç±»ç”¨æ¥ç®¡ç†æ–°è¿æ¥ï¼Œ å°† _  socketå†…éƒ¨æ•°æ®è½¬ç§»ç»™HttpConnectionç®¡ç†ï¼Œ_socketç»§ç»­ç”¨æ¥æ¥å—å†™çš„é“¾æ¥ã€‚

3. **HttpConnectionç±»**

   _buffer ç”¨æ¥æ¥å—æ•°æ®

   _request ç”¨æ¥è§£æè¯·æ±‚

   _response ç”¨æ¥å›åº”å®¢æˆ·ç«¯

   _deadline ç”¨æ¥åšå®šæ—¶å™¨åˆ¤æ–­è¯·æ±‚æ˜¯å¦è¶…æ—¶

   åœ¨HttpConnection::Startå†…éƒ¨è°ƒç”¨http::async_readå‡½æ•°

   å¤„ç†è¯·æ±‚æ—¶å°†HttpConnectionçš„æŒ‡é’ˆä¼ ç»™LogicSystem

4. **LogicSystemç±»**

   `LogicSystem` æ˜¯ä¸€ä¸ªå•ä¾‹ç±»ï¼Œç”¨äºå¤„ç† HTTP è¯·æ±‚ï¼ˆGET å’Œ POSTï¼‰ï¼Œå¹¶æ³¨å†Œç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚å®ƒé€šè¿‡ `HttpHandler` å‡½æ•°ç±»å‹æ¥å®šä¹‰æ¯ä¸ª URL è·¯å¾„å¯¹åº”çš„å¤„ç†é€»è¾‘ã€‚

   å°†å¤„ç†åçš„å›åº”responseä¼ ç»™HttpConnection

   ç„¶åHttpConnection::WriteResponseå› ä¸ºhttpæ˜¯çŸ­é“¾æ¥ï¼Œæ‰€ä»¥å‘é€å®Œæ•°æ®åä¸éœ€è¦å†ç›‘å¬å¯¹æ–¹é“¾æ¥ï¼Œç›´æ¥æ–­å¼€å‘é€ç«¯å³å¯ã€‚

5. **å®ç°postè¯·æ±‚** (ç”¨åˆ°äº†JsonCpp  jsoncppä½¿ç”¨)

   **VerifyGrpcClientç±»**

   grpcç¼–è¯‘message.proto å®šä¹‰äº†ä¸€ä¸ªéªŒè¯æœåŠ¡ï¼ˆ`VarifyService`ï¼‰ï¼Œåœ¨LogicSystemé‡ŒRegPost("/get_varifycode"ï¼‰å®ç°

   GetVarifyRsp rsp = VerifyGrpcClient::GetInstance()->GetVarifyCode(email)è°ƒç”¨

   VerifyGrpcClientä¸­çš„stub_->GetVarifyCode(&context, request, &reply);

   é€šè¿‡ `stub_` è°ƒç”¨è¿œç¨‹æ–¹æ³• `GetVarifyCode`ï¼Œå°†è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œå¹¶ç­‰å¾…æœåŠ¡å™¨è¿”å› `reply`ã€‚

6. **æå‡GateServerå¹¶å‘**

   æ·»åŠ ASIO IOContext Pool ç»“æ„ï¼Œè®©å¤šä¸ªiocontextè·‘åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œè¯¦ç»†è§Asioå­¦ä¹ :Asioå¤šçº¿ç¨‹æ¨¡å‹

   ä¿®æ”¹CServerå¤„Starté€»è¾‘, **æ”¹ä¸ºæ¯æ¬¡ä»IOServicePoolè¿æ¥æ± ä¸­è·å–è¿æ¥**

7. **æå‡VerifyGrpcClientæ€§èƒ½**(grpcè¿æ¥æ± æ€ä¹ˆå®ç°çš„ï¼Ÿ)

   å®ç°äº†ä¸€ä¸ª **gRPC è¿æ¥æ± ** (`RPConPool`)ï¼Œç”¨äºç®¡ç†å¤šä¸ª `VarifyService::Stub` çš„å®ä¾‹ã€‚è¯¥è¿æ¥æ± å…è®¸è¯·æ±‚è¿æ¥ï¼Œå¹¶åœ¨ä½¿ç”¨å®Œåå½’è¿˜è¿æ¥ã€‚è¿™æ ·å¯ä»¥é¿å…æ¯æ¬¡ RPC è°ƒç”¨æ—¶éƒ½åˆ›å»ºæ–°çš„è¿æ¥ï¼Œæå‡æ€§èƒ½ã€‚

   åˆ›å»º `poolSize_` ä¸ª `VarifyService::Stub` å®ä¾‹ï¼Œ**ä¸ºGateServerä¸VarifyServerçš„Grpcè¿æ¥**

   **VerifyGrpcClientä¸­çš„stub_->GetVarifyCode(&context, request, &reply)æ¯æ¬¡ä»è¿æ¥æ± æ‹¿stub,ç„¶åæ”¾å›**

   

   

   

## VarifyServeræœåŠ¡å™¨

æ”¶åˆ°grpcè¯·æ±‚å‘é€éªŒè¯ç 




# 1.å¥‡å¼‚é€’å½’æ¨¡æ¿æ¨¡å¼ï¼ˆCRTP)

[Design Patterns With C++ï¼ˆå…«ï¼‰CRTPï¼ˆä¸Šï¼‰ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/142407249)

# 2.å•ä¾‹æ¨¡å¼



```cpp
#include <memory>
#include <mutex>
#include <iostream>
using namespace std;
template <typename T>
class Singleton {
protected:
    Singleton() = default;
    Singleton(const Singleton<T>&) = delete;
    Singleton& operator=(const Singleton<T>& st) = delete;

    static std::shared_ptr<T> _instance;
public:
    static std::shared_ptr<T> GetInstance() {
        static std::once_flag s_flag;
        std::call_once(s_flag, [&]() {
            //ç»§æ‰¿æ¨¡ç‰ˆå•ä¾‹ç±»çš„å­ç±»çš„æ„é€ ä¼šè®¾ç½®ä¸ºprivateï¼Œmake_sharedæ— æ³•è®¿é—®ç§æœ‰çš„æ„é€ å‡½æ•°
            _instance = shared_ptr<T>(new T);
            });

        return _instance;
    }
    void PrintAddress() {
        std::cout << _instance.get() << endl;
    }
    ~Singleton() {
        std::cout << "this is singleton destruct" << std::endl;
    }
};

template <typename T>
std::shared_ptr<T> Singleton<T>::_instance = nullptr;
```

## æ¨¡ç‰ˆä½¿ç”¨å•ä¾‹

```c++
// ç¤ºä¾‹ç±»ï¼Œä½œä¸ºå•ä¾‹ç±»çš„å…·ä½“ç±»å‹
class MyClass {
public:
    MyClass() {
        std::cout << "MyClass Constructor" << std::endl;
    }

    void SayHello() {
        std::cout << "Hello from MyClass!" << std::endl;
    }
};

int main() {
    // è·å–å•ä¾‹å®ä¾‹
    auto instance = Singleton<MyClass>::GetInstance();
    
    // è°ƒç”¨å®ä¾‹çš„æ–¹æ³•
    instance->SayHello();
    
    // æ‰“å°å®ä¾‹çš„å†…å­˜åœ°å€
    instance->PrintAddress();
    
    // è·å–å•ä¾‹çš„ç¬¬äºŒæ¬¡å®ä¾‹ï¼Œå¹¶éªŒè¯å®ƒæ˜¯åŒä¸€ä¸ªå¯¹è±¡
    auto instance2 = Singleton<MyClass>::GetInstance();
    instance2->PrintAddress();

    return 0;
}
```



## ç»§æ‰¿å®ç°å•ä¾‹

```c++
// ç»§æ‰¿ Singleton ç±»
class MySingleton : public Singleton<MySingleton> {
public:
    MySingleton() {
        std::cout << "MySingleton Constructor" << std::endl;
    }

    void SayHello() {
        std::cout << "Hello from MySingleton!" << std::endl;
    }
};

int main() {
    // è·å– MySingleton çš„å•ä¾‹å®ä¾‹
    auto instance = MySingleton::GetInstance();
    
    // è°ƒç”¨å®ä¾‹çš„æ–¹æ³•
    instance->SayHello();
    
    // æ‰“å°å®ä¾‹çš„å†…å­˜åœ°å€
    instance->PrintAddress();
    
    // è·å– MySingleton çš„ç¬¬äºŒæ¬¡å®ä¾‹ï¼Œå¹¶éªŒè¯å®ƒæ˜¯åŒä¸€ä¸ªå¯¹è±¡
    auto instance2 = MySingleton::GetInstance();
    instance2->PrintAddress();

    return 0;
}

```



# 3.httpè¯·æ±‚æ–¹å¼get post ......

HTTPè¯·æ±‚æ–¹å¼ï¼ˆä¹Ÿç§°ä¸ºHTTPæ–¹æ³•ï¼‰æ˜¯HTTPåè®®ä¸­ç”¨äºå®šä¹‰å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨äº¤äº’è¡Œä¸ºçš„ä¸€ç»„æ ‡å‡†æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„HTTPè¯·æ±‚æ–¹å¼åŠå…¶ç”¨é€”ï¼š

------

### 1. **GET**

- åŠŸèƒ½ï¼š
  - è¯·æ±‚æŒ‡å®šèµ„æºï¼Œå¹¶ä»æœåŠ¡å™¨è·å–æ•°æ®ã€‚
- ç‰¹ç‚¹ï¼š
  - æ•°æ®é€šè¿‡URLä¼ é€’ï¼ˆä½œä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²ï¼‰ã€‚
  - **ä¸åº”æœ‰å‰¯ä½œç”¨**ï¼Œå³è¯·æ±‚èµ„æºä¸ä¼šæ”¹å˜æœåŠ¡å™¨çš„çŠ¶æ€ï¼ˆå±äºå¹‚ç­‰æ“ä½œï¼‰ã€‚
  - è¯·æ±‚çš„æ•°æ®å¤§å°å—é™äºURLé•¿åº¦ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - è·å–ç½‘é¡µã€æ–‡ä»¶ã€å›¾åƒç­‰èµ„æºã€‚
  - é€šè¿‡URLæŸ¥è¯¢å‚æ•°è·å–æ•°æ®ï¼ˆå¦‚æœç´¢å¼•æ“æŸ¥è¯¢ï¼‰ã€‚

------

### 2. **POST**

- åŠŸèƒ½ï¼š
  - å‘æœåŠ¡å™¨æäº¤æ•°æ®ï¼Œç”¨äºåˆ›å»ºæˆ–å¤„ç†èµ„æºã€‚
- ç‰¹ç‚¹ï¼š
  - æ•°æ®åŒ…å«åœ¨è¯·æ±‚ä½“ä¸­ï¼Œä¼ è¾“æ•°æ®é‡è¾ƒå¤§ã€‚
  - é€šå¸¸ç”¨äºæœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼ˆå¦‚æ·»åŠ æ•°æ®ï¼‰ã€‚
  - **ä¸å¹‚ç­‰**ï¼Œå³å¤šæ¬¡ç›¸åŒçš„è¯·æ±‚å¯èƒ½å¯¼è‡´ä¸åŒç»“æœã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - æäº¤è¡¨å•æ•°æ®ã€‚
  - ä¸Šä¼ æ–‡ä»¶ã€‚
  - å‘é€JSONæˆ–XMLç­‰æ ¼å¼çš„æ•°æ®ã€‚

------

### 3. **PUT**

- åŠŸèƒ½ï¼š
  - å‘æœåŠ¡å™¨ä¸Šä¼ æ•°æ®ï¼Œç”¨äº**åˆ›å»º**æˆ–**æ›´æ–°**èµ„æºã€‚
- ç‰¹ç‚¹ï¼š
  - æ•°æ®åŒ…å«åœ¨è¯·æ±‚ä½“ä¸­ã€‚
  - **å¹‚ç­‰**ï¼šå¤šæ¬¡ç›¸åŒè¯·æ±‚çš„ç»“æœä¸€è‡´ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - æ›¿æ¢æŸä¸ªèµ„æºçš„å…¨éƒ¨å†…å®¹ã€‚
  - ç”¨äºæ›´æ–°æœåŠ¡å™¨èµ„æºçš„çŠ¶æ€æˆ–å†…å®¹ã€‚

------

### 4. **PATCH**

- åŠŸèƒ½ï¼š
  - å¯¹æœåŠ¡å™¨ä¸Šçš„èµ„æºè¿›è¡Œéƒ¨åˆ†æ›´æ–°ã€‚
- ç‰¹ç‚¹ï¼š
  - è¯·æ±‚ä½“ä¸­åŒ…å«éœ€è¦æ›´æ–°çš„éƒ¨åˆ†å†…å®¹ã€‚
  - **ä¸ä¸€å®šå¹‚ç­‰**ï¼šå…·ä½“çœ‹å®ç°ï¼Œå¦‚æœæ¯æ¬¡è¯·æ±‚çš„ç»“æœç›¸åŒåˆ™ä¸ºå¹‚ç­‰ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - æ›´æ–°èµ„æºçš„æŸäº›å­—æ®µæˆ–å±€éƒ¨å†…å®¹ã€‚

------

### 5. **DELETE**

- åŠŸèƒ½ï¼š
  - è¯·æ±‚æœåŠ¡å™¨åˆ é™¤æŒ‡å®šèµ„æºã€‚
- ç‰¹ç‚¹ï¼š
  - **å¹‚ç­‰**ï¼šåˆ é™¤ç›¸åŒèµ„æºå¤šæ¬¡ï¼Œæœ€ç»ˆçŠ¶æ€ä¸€è‡´ï¼ˆèµ„æºä¸å­˜åœ¨ï¼‰ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - åˆ é™¤ç”¨æˆ·ä¿¡æ¯ã€æ–‡ä»¶ã€æ•°æ®åº“è®°å½•ç­‰ã€‚

------

### 6. **HEAD**

- åŠŸèƒ½ï¼š
  - ç±»ä¼¼äºGETï¼Œä½†åªè¯·æ±‚èµ„æºçš„å¤´éƒ¨ä¿¡æ¯ï¼Œä¸è¿”å›å…·ä½“å†…å®¹ã€‚
- ç‰¹ç‚¹ï¼š
  - é€šå¸¸ç”¨äºæ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨æˆ–è·å–èµ„æºçš„å…ƒä¿¡æ¯ï¼ˆå¦‚å¤§å°ã€ä¿®æ”¹æ—¶é—´ï¼‰ã€‚
  - ä¸ä¼šå½±å“æœåŠ¡å™¨çš„çŠ¶æ€ï¼ˆæ— å‰¯ä½œç”¨ï¼‰ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - æ£€æŸ¥èµ„æºçš„å¯ç”¨æ€§ã€‚
  - è·å–æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ˆå¦‚`Content-Length`ï¼‰ã€‚

------

### 7. **OPTIONS**

- åŠŸèƒ½ï¼š
  - è¯·æ±‚æœåŠ¡å™¨è¿”å›æ”¯æŒçš„HTTPæ–¹æ³•åˆ—è¡¨ã€‚
- ç‰¹ç‚¹ï¼š
  - ç”¨äºè·¨åŸŸè¯·æ±‚æ—¶æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸æŒ‡å®šæ“ä½œï¼ˆCORSä¸­çš„é¢„æ£€è¯·æ±‚ï¼‰ã€‚
  - ä¸æ”¹å˜æœåŠ¡å™¨çš„çŠ¶æ€ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - æ£€æµ‹æŸèµ„æºçš„å¯ç”¨æ“ä½œã€‚
  - CORSè·¨åŸŸè¯·æ±‚çš„é¢„æ£€ã€‚

------

### 8. **TRACE**

- åŠŸèƒ½ï¼š
  - ç”¨äºè¯Šæ–­å’Œè°ƒè¯•ï¼Œå°†è¯·æ±‚åœ¨æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰æ“ä½œåŸæ ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
- ç‰¹ç‚¹ï¼š
  - é€šå¸¸ç”¨äºæµ‹è¯•HTTPè¯·æ±‚çš„è·¯å¾„ã€‚
  - å®‰å…¨æ€§è¾ƒä½ï¼Œå¯èƒ½ä¼šæš´éœ²æ•æ„Ÿä¿¡æ¯ï¼Œå› æ­¤ä¸å¸¸ä½¿ç”¨ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - HTTPè¯·æ±‚çš„è°ƒè¯•ã€‚

------

### 9. **CONNECT**

- åŠŸèƒ½ï¼š
  - å»ºç«‹åˆ°æœåŠ¡å™¨çš„éš§é“è¿æ¥ï¼ˆé€šå¸¸ç”¨äºSSL/TLSåŠ å¯†çš„HTTPSï¼‰ã€‚
- ç‰¹ç‚¹ï¼š
  - ä¸€èˆ¬ç”¨äºä»£ç†æœåŠ¡å™¨ï¼Œå»ºç«‹ä¸€ä¸ªä¸­è½¬é€šé“ã€‚
- åº”ç”¨åœºæ™¯ï¼š
  - é€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®HTTPSç½‘ç«™ã€‚

------

### **æ€»ç»“**

| **æ–¹æ³•**    | **å¹‚ç­‰æ€§** | **è¯·æ±‚ä½“** | **å¸¸ç”¨åœºæ™¯**       |
| ----------- | ---------- | ---------- | ------------------ |
| **GET**     | æ˜¯         | æ—          | è·å–æ•°æ®           |
| **POST**    | å¦         | æœ‰         | æäº¤æ•°æ®ã€åˆ›å»ºèµ„æº |
| **PUT**     | æ˜¯         | æœ‰         | æ›¿æ¢èµ„æº           |
| **PATCH**   | å¦         | æœ‰         | éƒ¨åˆ†æ›´æ–°èµ„æº       |
| **DELETE**  | æ˜¯         | æ—          | åˆ é™¤èµ„æº           |
| **HEAD**    | æ˜¯         | æ—          | è·å–å…ƒä¿¡æ¯         |
| **OPTIONS** | æ˜¯         | æ—          | æ£€æµ‹æ”¯æŒçš„æ–¹æ³•     |
| **TRACE**   | å¦         | æ—          | HTTPè¯·æ±‚è°ƒè¯•       |
| **CONNECT** | å¦         | æœ‰         | å»ºç«‹éš§é“è¿æ¥       |

------

**æ³¨æ„**

- GET å’Œ POST æ˜¯æœ€å¸¸ç”¨çš„è¯·æ±‚æ–¹æ³•ã€‚
- PUTã€PATCH å’Œ DELETE åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦åç«¯æ˜ç¡®æ”¯æŒï¼ˆæŸäº›æœåŠ¡å™¨æˆ–æ¡†æ¶éœ€è¦é¢å¤–é…ç½®ï¼‰ã€‚

## getå’ŒpoståŒºåˆ«(çœ‹csdn)

# 4.QTå®ç°http

# 5.QTä¿¡å·å’Œæ§½

# 6.é˜²æ­¢å¯¹è±¡ææ„ å…±äº«åº”ç”¨æŠ€æœ¯

å®ƒæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„å‘é€ï¼Œå‘é€å®Œäº†ä¹‹åå‘¢ï¼Ÿè¿™ä¸ªã€‚è°ƒç”¨å®Œpostä¹‹åå‘¢ï¼Œå¹¶ä¸èƒ½é©¬ä¸Šæ”¶åˆ°å¯¹æ–¹çš„å›åŒ…ã€‚

å“ï¼Œå®ƒä¼šQTç»™æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªreplyçš„è¿™æ ·ä¸€ä¸ªå®ä¾‹ã€‚è¿™ä¸ªreplyæˆ‘ä»¬åæœŸå‘¢ï¼Œè¦è‡ªåŠ¨çš„æ‰‹åŠ¨çš„å»å›æ”¶ã€‚ç„¶åå‘¢ï¼Ÿ

æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™èƒ½æ”¶åˆ°å®ƒçš„å›åŒ…ï¼Ÿä¸ç¡®å®šæ˜¯é€šè¿‡ä¸€ä¸ªlambdaçš„è¡¨è¾¾å¼ã€‚å‘Šè¯‰æˆ‘ä»¬ã€‚è¿™ä¸ªlambdaè¡¨è¾¾å¼å‘¢ï¼Œæˆ‘ä»¬åˆæ‹…å¿ƒåœ¨å¤„ç†è¿™ä¸ªlambdaè¡¨è¾¾å¼çš„è¿‡ç¨‹ä¸­å‘¢ã€‚

è¿™ä¸ªä¹‹å‰å·²ç»æŠŠè¿™ä¸ªhttp managerå‘¢ç»™å¹²æ‰äº†ã€‚æ‰€ä»¥æˆ‘ä»¬æ•è·çš„æ˜¯ä¸€ä¸ªselfã€‚é‚£æƒ³æ•è·selfå‘¢ï¼Ÿå®ƒæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå°±éœ€è¦é€šè¿‡thiså‘¢ï¼Ÿ

ç”Ÿæˆæ™ºèƒ½æŒ‡é’ˆï¼Œå°±é€šè¿‡è¿™ç§æ–¹å¼å‘¢ï¼Ÿç”Ÿæˆçš„æ™ºèƒ½æŒ‡é’ˆå’Œä¹‹å‰ç®¡ç†ç±»ä¼¼çš„æ™ºèƒ½æŒ‡é’ˆå‘¢ï¼Ÿè¾¾åˆ°å…±äº«åº”ç”¨æŠ€æœ¯çš„ä¸€ä¸ªç›®çš„ï¼Œè¦æƒ³ç”¨è¿™ä¸ªå‡½æ•°å‘¢ã€‚

é‚£æˆ‘ä»¬ã€‚åˆç»™å¤§å®¶ä»‹ç»äº†è¦ä½¿ç”¨è¿™æ ·ä¸€ä¸ªåŸºç±»ï¼Œé‚£ä¹ˆè¿™ä¸ªåŸºç±»å®ƒçš„æ¨¡æ¿ç±»å‹ä¼ é€’çš„å®å®ä¾‹å‘¢ï¼Ÿä¹Ÿæ˜¯è¿™ä¸ªhttp managerã€‚è¿™ä¸ªä¹Ÿç›¸å½“äºå…¶é€’å½’æ¨¡æ¿çš„ä¸€æ¬¡ä½¿ç”¨ã€‚

```cpp
void HttpMgr::PostHttpReq(QUrl url, QJsonObject json, ReqId req_id, Modules mod)
{
    //åˆ›å»ºä¸€ä¸ªHTTP POSTè¯·æ±‚ï¼Œå¹¶è®¾ç½®è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“
    QByteArray data = QJsonDocument(json).toJson();
    //é€šè¿‡urlæ„é€ è¯·æ±‚
    QNetworkRequest request(url);
    request.setHeader(QNetworkRequest::ContentTypeHeader, "application/json");
    request.setHeader(QNetworkRequest::ContentLengthHeader, QByteArray::number(data.length()));
    //å‘é€è¯·æ±‚ï¼Œå¹¶å¤„ç†å“åº”, è·å–è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆï¼Œæ„é€ ä¼ªé—­åŒ…å¹¶å¢åŠ æ™ºèƒ½æŒ‡é’ˆå¼•ç”¨è®¡æ•°
    auto self = shared_from_this();
    QNetworkReply * reply = _manager.post(request, data);
    //è®¾ç½®ä¿¡å·å’Œæ§½ç­‰å¾…å‘é€å®Œæˆ
    QObject::connect(reply, &QNetworkReply::finished, [reply, self, req_id, mod](){
        //å¤„ç†é”™è¯¯çš„æƒ…å†µ
        if(reply->error() != QNetworkReply::NoError){
            qDebug() << reply->errorString();
            //å‘é€ä¿¡å·é€šçŸ¥å®Œæˆ
            emit self->sig_http_finish(req_id, "", ErrorCodes::ERR_NETWORK, mod);
            reply->deleteLater();
            return;
        }

        //æ— é”™è¯¯åˆ™è¯»å›è¯·æ±‚
        QString res = reply->readAll();

        //å‘é€ä¿¡å·é€šçŸ¥å®Œæˆ
        emit self->sig_http_finish(req_id, res, ErrorCodes::SUCCESS,mod);
        reply->deleteLater();
        return;
    });
}

```

# 7.asioåº•å±‚

# 8.try catch

# 9.jsonå’Œprotobuf

## protobufä½¿ç”¨

# 10.ç²˜åŒ…é—®é¢˜	

# 11.é€šä¿¡è¿‡ç¨‹  httpï¼Ÿ(çŸ­è¿æ¥ï¼Ÿ)   tcpé•¿è¿æ¥ï¼Ÿ   websocketï¼Ÿ

# 12.æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­å®¢æˆ·ç«¯å¼•å‘timewaitï¼Ÿ

# 13.å‰ç½®å£°æ˜è§£å†³äº’å¼•ç”¨

# 14. boost::urls::encode

# 15.ç§»æ¤åˆ°linuxä¸‹

```cmake
cmake_minimum_required(VERSION 3.10)

# é¡¹ç›®ä¿¡æ¯
project(GateServer)

# æŒ‡å®š C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED True)

# æ·»åŠ  Boost åº“
find_package(Boost REQUIRED)
if(Boost_FOUND)
    include_directories(${Boost_INCLUDE_DIRS})
endif()

# æ·»åŠ  jsoncpp åº“
find_package(jsoncpp REQUIRED)
if(jsoncpp_FOUND)
    include_directories(${jsoncpp_INCLUDE_DIRS})
endif()

# æºæ–‡ä»¶åˆ—è¡¨
set(SOURCES
    GateServer.cpp
    CServer.cpp
    HttpConnection.cpp
    LogicSystem.cpp
)

# å¤´æ–‡ä»¶ç›®å½•
include_directories(${CMAKE_SOURCE_DIR})

# ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
add_executable(GateServer ${SOURCES})

# é“¾æ¥åº“
target_link_libraries(GateServer 
    pthread
    ${Boost_LIBRARIES}
    jsoncpp
)

```



### `std::string` å’Œ `boost::basic_string_view` ä¸å…¼å®¹

Boost ä¸­çš„ `basic_string_view` å’Œ `std::string` å¹¶ä¸èƒ½ç›´æ¥èµ‹å€¼ï¼Œå¿…é¡»æ˜¾å¼åœ°è¿›è¡Œè½¬æ¢ã€‚

- å¦‚æœ `uri` æ˜¯ `boost::basic_string_view` ç±»å‹ï¼Œéœ€æ˜¾å¼è½¬æ¢ä¸º `std::string`ï¼š

```
_get_url = std::string(uri);
```

- å¦‚æœéœ€è¦æˆªå– `uri` çš„å­å­—ç¬¦ä¸²ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š

```
_get_url = std::string(uri.substr(0, query_pos));
```

è¿™å°†ä» `boost::basic_string_view` è½¬æ¢ä¸º `std::string`ã€‚

# **16.å…ˆæŠŠæ‰€æœ‰copyå®Œï¼Œæœ€åå†ç»†è‡´å­¦ä¹ æ¯ä¸ªå°èŠ‚

# å®Œæˆåæ¢³ç†   

# æ–‡æ¡£ä¸å…¨

# æ€»ç»“   

# å†™å‡ºä»£ç æ¡†æ¶é€»è¾‘ç»“æ„

# è‡ªå·±é‡å†™ä¸€ç‚¹ä»£ç   

# è´¹æ›¼å­¦ä¹ æ³•å†™åšå®¢

# å…¨éƒ¨ç§»æ¤åˆ°linuxä¸‹ï¼Œåˆ©ç”¨docker

# **17.ASIOå’Œå…¶ä»–ç½‘ç»œåº“å¯¹æ¯”

# 18.rpcåŸç†åŠåº”ç”¨

# 19.å‡½æ•°å‚æ•° *   &      åœ¨è°ƒç”¨æ—¶å‚æ•°æ€ä¹ˆå†™

  å¦‚void aï¼ˆint *a,int &b);

### è°ƒç”¨æ—¶çš„å†™æ³•

#### å¯¹äºæŒ‡é’ˆå‚æ•° `int *p`

1. å¿…é¡»ä¼ é€’ä¸€ä¸ªæœ‰æ•ˆçš„æŒ‡é’ˆã€‚
2. å¦‚æœéœ€è¦ä¿®æ”¹åŸå˜é‡çš„å€¼ï¼Œå¯ä»¥ä¼ é€’å˜é‡çš„åœ°å€ã€‚

ç¤ºä¾‹ï¼š

```
cppå¤åˆ¶ä»£ç int x = 5;
a(&x, r);  // å°†å˜é‡ x çš„åœ°å€ä¼ å…¥
```

#### å¯¹äºå¼•ç”¨å‚æ•° `int &r`

1. å¿…é¡»ä¼ é€’ä¸€ä¸ªå˜é‡ï¼ˆä¸èƒ½æ˜¯å¸¸é‡æˆ–è¡¨è¾¾å¼ï¼‰ã€‚
2. å¼•ç”¨æ˜¯ç›´æ¥ç»‘å®šåˆ°å®å‚å˜é‡çš„ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å†™å˜é‡åã€‚

ç¤ºä¾‹ï¼š

```
cppå¤åˆ¶ä»£ç int y = 5;
a(&x, y);  // ä¼ é€’å˜é‡ yï¼Œæœ¬èº«è¢«ç›´æ¥ä¿®æ”¹
```

# 20.grpcçš„ä½¿ç”¨

```protobuf
syntax = "proto3";

package message;

service VarifyService {
  rpc GetVarifyCode (GetVarifyReq) returns (GetVarifyRsp) {}
}

message GetVarifyReq {
  string email = 1;
}

message GetVarifyRsp {
  int32 error = 1;
  string email = 2;
  string code = 3;
}
```

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ª **Protocol Buffers (Protobuf)** çš„å®šä¹‰æ–‡ä»¶ï¼Œç”¨äºæè¿°ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿä¸­çš„é€šä¿¡æ¥å£ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªæœåŠ¡ `VarifyService`ï¼Œä»¥åŠç›¸å…³çš„è¯·æ±‚å’Œå“åº”æ¶ˆæ¯ã€‚

### é€éƒ¨åˆ†è§£é‡Šï¼š

1. **`syntax = "proto3";`**
    è¿™è¡¨ç¤ºä½¿ç”¨ **Protobuf 3** ç‰ˆæœ¬çš„è¯­æ³•è¿›è¡Œå®šä¹‰ã€‚`proto3` æ˜¯ Protobuf çš„ä¸€ç§è¯­æ³•ç‰ˆæœ¬ï¼Œæ”¯æŒæ›´ç®€æ´çš„å®šä¹‰æ–¹å¼ã€‚
2. **`package message;`**
    è¿™å®šä¹‰äº†æ¶ˆæ¯çš„å‘½åç©ºé—´ã€‚æ‰€æœ‰çš„æ¶ˆæ¯å’ŒæœåŠ¡éƒ½ä¼šè¢«æ”¾åœ¨ `message` è¿™ä¸ªåŒ…é‡Œã€‚
3. **`service VarifyService { ... }`**
    è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªåä¸º `VarifyService` çš„æœåŠ¡ã€‚æœåŠ¡åŒ…å«å¤šä¸ª RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰æ–¹æ³•ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œåªæœ‰ä¸€ä¸ª RPC æ–¹æ³•ï¼š
   - `GetVarifyCode`ï¼Œå®ƒæ¥å— `GetVarifyReq` ç±»å‹çš„è¯·æ±‚ï¼Œè¿”å› `GetVarifyRsp` ç±»å‹çš„å“åº”ã€‚
4. **`rpc GetVarifyCode (GetVarifyReq) returns (GetVarifyRsp) {}`**
    å®šä¹‰äº†ä¸€ä¸ªè¿œç¨‹è°ƒç”¨ `GetVarifyCode`ï¼Œæ¥æ”¶ä¸€ä¸ª `GetVarifyReq` ç±»å‹çš„è¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ª `GetVarifyRsp` ç±»å‹çš„å“åº”ã€‚`GetVarifyReq` å¯èƒ½åŒ…å«ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€ï¼Œ`GetVarifyRsp` åˆ™è¿”å›ä¸€ä¸ªéªŒè¯ä»£ç åŠå¯èƒ½çš„é”™è¯¯ä¿¡æ¯ã€‚
5. **`message GetVarifyReq { string email = 1; }`**
    è¿™æ˜¯è¯·æ±‚æ¶ˆæ¯ `GetVarifyReq`ï¼Œå®ƒåŒ…å«ä¸€ä¸ªå­—æ®µ `email`ï¼Œç±»å‹æ˜¯ `string`ã€‚å­—æ®µç¼–å· `1` è¡¨ç¤º Protobuf åºåˆ—åŒ–æ—¶çš„å­—æ®µç´¢å¼•ã€‚
6. **`message GetVarifyRsp { int32 error = 1; string email = 2; string code = 3; }`**
    è¿™æ˜¯å“åº”æ¶ˆæ¯ `GetVarifyRsp`ï¼ŒåŒ…å«ä¸‰ä¸ªå­—æ®µï¼š
   - `error`ï¼ˆ`int32` ç±»å‹ï¼‰ï¼šè¡¨ç¤ºé”™è¯¯ä»£ç ã€‚
   - `email`ï¼ˆ`string` ç±»å‹ï¼‰ï¼šè¿”å›çš„ç”µå­é‚®ä»¶åœ°å€ã€‚
   - `code`ï¼ˆ`string` ç±»å‹ï¼‰ï¼šè¿”å›çš„éªŒè¯ç ã€‚

### ç”¨é€”ï¼š

è¿™ä¸ª Protobuf æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªéªŒè¯æœåŠ¡ï¼ˆ`VarifyService`ï¼‰ï¼Œç”¨äºé€šè¿‡ç”µå­é‚®ä»¶è·å–éªŒè¯ç ã€‚å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ RPC è°ƒç”¨ `GetVarifyCode` æ–¹æ³•ï¼Œå¹¶ä¼ é€’ç”µå­é‚®ä»¶åœ°å€ä½œä¸ºè¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›éªŒè¯ç»“æœå’ŒéªŒè¯ç ã€‚

**åˆ©ç”¨å‘½ä»¤ä¼šç”Ÿæˆmessage.pb.hå’Œmessage.pb.ccæ–‡ä»¶**

ç„¶åè‡ªå·±ä»£ç å®ç°GetVarifyCodeå‡½æ•°

# 21.ç¬¬ä¹èŠ‚nodejsæ”¹ä¸ºc++/go?

# 22.çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ

æˆ‘ä»¬çš„get serveå‘¢ï¼Œå®é™…ä¸Šæ˜¯ç”¨BSçš„å»å®ç°çš„ï¼Œè¿™æ ·ä¸€ä¸ªç½‘ç»œåº“httpçš„ï¼Œè¿™æ ·ä¸€ä¸ªæœåŠ¡ã€‚htpè¿™ä¸ªæœåŠ¡å¤§å®¶çŸ¥é“ï¼Œå®ƒå®é™…ä¸Šæ˜¯é¢å‘çš„ï¼Œæ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šä¸ªè¿æ¥è¿è¿‡æ¥çš„æ—¶å€™å¯èƒ½ã€‚ä¼šæœ‰å¤šä¸ªåº•å±‚æ˜¯å¤šä¸ªçº¿ç¨‹å»è§¦å‘çš„ï¼Œé‚£ä¹ˆå®ƒå¯¹äºçº¿ç¨‹æ¥è¯´å‘¢ï¼Œæ˜¯ä¸å®‰å…¨çš„ï¼Œå¯¹å§ï¼Ÿhttpæˆ‘ä»¬çš„å›è°ƒï¼Œå®é™…ä¸Šæˆ‘ä»¬æ˜¯åœ¨è¿™é‡Œçœ‹åˆ°çš„ã€‚å³ä¾¿æˆ‘ä»¬é€šè¿‡çš„æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œ

å»åœ¨ä¸Šå±‚æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯åº•å±‚å‘¢ï¼Œå¯èƒ½æ˜¯å¤šä¸ªçº¿ç¨‹ã€‚é‚£æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ã€‚é‚£ä¹ˆå…¶å®è¿˜å¥½ï¼Œå› ä¸ºæˆ‘ä»¬è¿™ä¸ªå¤§å®¶çœ‹æˆ‘ä»¬åªåˆ›å»ºäº†è¿™æ ·ä¸€ä¸ªæœåŠ¡è·‘ï¼Œåœ¨è¿™æ ·ä¸€ä¸ªä¸»çº¿ç¨‹é‡Œã€‚é‚£ä¹ˆï¼Œå®ƒæ‰€æœ‰çš„å›è°ƒå‘¢ï¼Ÿå…¶å®éƒ½æ˜¯åœ¨é€šè¿‡ä¸»çº¿ç¨‹çš„è¿™æ ·ä¸€ä¸ªå•Šlcçš„ï¼Œè¿™æ ·ä¸€ä¸ªæœåŠ¡å»å›è°ƒçš„ï¼Œå®é™…ä¸Šå®ƒæ˜¯ä¸€ä¸ªå•çº¿ç¨‹ã€‚è€Œå¦‚æœåæœŸå‘¢ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªhttpè¿™ä¸ªæœåŠ¡å‘¢ï¼Œæˆ‘ä»¬ç»™å®ƒåˆ›å»ºå¾ˆå¤šä¸ªè¿™æ ·ä¸€ä¸ªlcè·‘åœ¨ä¸åŒçš„çº¿ç¨‹ã€‚

æ¥æå‡å®ƒçš„ä¸€ä¸ªå¹¶å‘èƒ½åŠ›çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå®ƒçš„å›è°ƒæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒå®Œæˆäº†è¿™æ ·ä¸€ä¸ªã€‚å‘ƒï¼Œå›æ‰ã€‚æ¯”å¦‚è¯´åœ¨s everé‡Œï¼Œæˆ‘ä»¬æœ‰ä¸ªstartã€‚startè¿™é‡Œç”¨çš„è¿™ä¸ªlcï¼Œå®ƒçš„å›è°ƒæ˜¯è¿™æ ·ä¸€ä¸ªè¿æ¥å®ƒæ¥æ”¶è¿æ¥çš„æ—¶å€™å‘¢ï¼Œå¯èƒ½ä¼šå‘ƒå¤„äºä¸åŒçš„è¿™æ ·ä¸€ä¸ªã€‚å‘ƒï¼Œçº¿ç¨‹é‡Œå½“ç„¶æˆ‘ä»¬å¯ä»¥è®©æ¥æ”¶è¿æ¥å‘¢ï¼Œç»‘å®šåœ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯æˆ‘ä»¬å¤„ç†connectionçš„æ—¶å€™å‘¢ï¼Œå¯èƒ½è¿™é‡Œå‘¢ï¼Œæˆ‘ä»¬å°±è¦å»ã€‚

å‘ƒï¼Œæå¤šä¸ªã€‚æè¿™æ ·å¤šä¸ªçš„ï¼Œè¿™è¿™ä¸ªIOCäº†ï¼Œé‚£ä¹ˆè·‘åœ¨å¤šä¸ªçº¿ç¨‹é‡Œï¼Œå¦‚æœå¯htp connectionè·‘åœ¨å¤šä¸ªçº¿ç¨‹é‡Œçš„æ—¶å€™ã€‚é‚£ä¹ˆï¼Œå®ƒçš„å›è°ƒå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œé‚£å¦‚æœæˆ‘ä»¬çš„å®ƒæ¥è°ƒç”¨æˆ‘ä»¬çš„logicçš„è¯ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬å¤„ç†è¯·æ±‚è°ƒç”¨æˆ‘ä»¬çš„logicã€‚å¤„ç†poseçš„è¯·æ±‚çš„æ—¶å€™ã€‚åœ¨ä¸Šé¢èµ°ï¼Œå®ƒåˆè°ƒåˆ°äº†æˆ‘ä»¬jr PCçš„è¿™æ ·ä¸€ä¸ªè¿æ¥ã€‚é‚£å¦‚æœjr PCçš„è¿™ä¸ªè¿æ¥ã€‚

å“ï¼Œå®ƒè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„è¯ï¼Œé‚£å°±ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé‚£ä¹ˆä¸ºäº†è§£å†³è¿™ç§é—®é¢˜å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªè¿æ¥æ± çš„æ¦‚å¿µã€‚æˆ‘ä»¬ä¼šåˆå§‹åŒ–nä¸ªè¿æ¥ï¼Œè¿æ¥åˆ°jr PCæœåŠ¡é‡Œã€‚ç„¶åå‘¢ï¼Ÿæ¯ä¸ªçº¿ç¨‹å‘¢ï¼Ÿå»å–è‡ªå·±çš„ä¸€ä¸ªé“¾æ¥ï¼Œç”¨å®Œäº†ä¹‹åå‘¢ï¼Ÿå†è¿˜å›æ¥ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿™ä¸ªhttpå‘¢ï¼Œåªæœ‰ä¸€ä¸ªIOCæœåŠ¡å‘¢ã€‚

æ˜¾å¾—æœ‰ä¸€äº›æ‹…ä¿ï¼Œæˆ‘ä»¬å°½å¯èƒ½çš„æŠŠæ¥æ”¶è¿æ¥è·Ÿå¤„ç†è¿æ¥å‘¢åˆ†å¼€ã€‚é‚£ä¹ˆï¼Œæ¥æ”¶è¿æ¥å‘¢ï¼Ÿæˆ‘ä»¬è¿˜ç”¨è¿™ä¸ªlcï¼Œè€Œå½“æˆ‘ä»¬å¤„ç†è¿æ¥çš„æ—¶å€™å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¯åŠ¨å¤šä¸ªlcã€‚è·‘åœ¨ä¸åŒçš„å¿åŸé‡Œã€‚é‚£ä¹ˆè¿™æ ·å‘¢ï¼Œæˆ‘ä»¬httpçš„æœåŠ¡å‘¢ï¼Œå°±æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„äº†ã€‚é‚£ä¹ˆï¼Œèƒ½å¤Ÿè§£å†³ä¸€äº›ã€‚é«˜å¹¶å‘çš„è¿™æ ·ä¸€ä¸ªè®¿é—®ã€‚å—¯ï¼Œ

# 23. çº¿ç¨‹æ± 

ä»»åŠ¡æ— é¡ºåºï¼Œä¸å¼ºå…³è”ï¼Œé€‚åˆçº¿ç¨‹æ± 

![image-20241127191524955](C:\Users\86138\AppData\Roaming\Typora\typora-user-images\image-20241127191524955.png)

```cpp
#ifndef __THREAD_POOL_H__
#define __THREAD_POOL_H__

#include <atomic>
#include <condition_variable>
#include <future>
#include <iostream>
#include <mutex>
#include <queue>
#include <thread>
#include <vector>

class ThreadPool  {
public:
    ThreadPool(const ThreadPool&) = delete;
    ThreadPool&        operator=(const ThreadPool&) = delete;

    static ThreadPool& instance() {
        static ThreadPool ins;
        return ins;
    }

    using Task = std::packaged_task<void()>;


    ~ThreadPool() {
        stop();
    }

    template <class F, class... Args>
    auto commit(F&& f, Args&&... args) -> std::future<decltype(f(args...))> {
        using RetType = decltype(f(args...));
        if (stop_.load())
            return std::future<RetType>{};

        auto task = std::make_shared<std::packaged_task<RetType()>>(
            std::bind(std::forward<F>(f), std::forward<Args>(args)...));

        std::future<RetType> ret = task->get_future();
        {
            std::lock_guard<std::mutex> cv_mt(cv_mt_);
            tasks_.emplace([task] { (*task)(); });
        }
        cv_lock_.notify_one();
        return ret;
    }

    int idleThreadCount() {
        return thread_num_;
    }

private:
    ThreadPool(unsigned int num = 5)
        : stop_(false) {
            {
                if (num < 1)
                    thread_num_ = 1;
                else
                    thread_num_ = num;
            }
            start();
    }
    void start() {
        for (int i = 0; i < thread_num_; ++i) {
            pool_.emplace_back([this]() {
                while (!this->stop_.load()) {
                    Task task;
                    {
                        std::unique_lock<std::mutex> cv_mt(cv_mt_);
                        this->cv_lock_.wait(cv_mt, [this] {
                            return this->stop_.load() || !this->tasks_.empty();
                        });
                        if (this->tasks_.empty())
                            return;

                        task = std::move(this->tasks_.front());
                        this->tasks_.pop();
                    }
                    this->thread_num_--;
                    task();
                    this->thread_num_++;
                }
            });
        }
    }
    void stop() {
        stop_.store(true);
        cv_lock_.notify_all();
        for (auto& td : pool_) {
            if (td.joinable()) {
                std::cout << "join thread " << td.get_id() << std::endl;
                td.join();
            }
        }
    }

private:
    std::mutex               cv_mt_;
    std::condition_variable  cv_lock_;
    std::atomic_bool         stop_;
    std::atomic_int          thread_num_;
    std::queue<Task>         tasks_;
    std::vector<std::thread> pool_;
};

#endif  // !__THREAD_POOL_H__
```

# 24.æå‡gateserverå¹¶å‘ï¼Œæ”¹ä¸ºå¤šçº¿ç¨‹

# 25.é¡¹ç›®å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨

# **26.redisç¼–ç¨‹  ä½¿ç”¨c++å®ç°

# **27.grpcç¼–ç¨‹

# 28.mysqlä¸æš´éœ²ç«¯å£ï¼Ÿåˆ©ç”¨docker?

# 29.ç®€å•æµç¨‹![image-20241216225915200](C:\Users\86138\AppData\Roaming\Typora\typora-user-images\image-20241216225915200.png)

# 30.å½“è¾“å…¥å«æœ‰é‡å¤çš„ç”¨æˆ·åæˆ–é‚®ç®±ä¸­çš„ä¸€é¡¹ï¼Œå¿…é¡»ä¿®æ”¹è¿™ä¸¤é¡¹æ‰èƒ½æ³¨å†Œï¼Ÿbug

# 31.

![image-20241218143512722](C:\Users\86138\AppData\Roaming\Typora\typora-user-images\image-20241218143512722.png)

![image-20241218143654586](C:\Users\86138\AppData\Roaming\Typora\typora-user-images\image-20241218143654586.png)

# 32.é›†ç¾¤  å¾®æœåŠ¡ åŒºåˆ«  ä¼˜ç¼ºç‚¹

# 33.è‡ªå·±è®¾è®¡ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ±   è¿æ¥æ± çš„å¥½å¤„

# 34.grpcè¿æ¥æ± (è‡ªå·±å†™ä¸€é)

```c++
class RPConPool {
public:
    RPConPool(size_t poolSize, std::string host, std::string port)
        : poolSize_(poolSize), host_(host), port_(port), b_stop_(false) {
        for (size_t i = 0; i < poolSize_; ++i) {

        std::shared_ptr<Channel> channel = grpc::CreateChannel(host+":"+port,
            grpc::InsecureChannelCredentials());

        connections_.push(VarifyService::NewStub(channel));
    }
}

~RPConPool() {
    std::lock_guard<std::mutex> lock(mutex_);
    Close();
    while (!connections_.empty()) {
        connections_.pop();
    }
}

std::unique_ptr<VarifyService::Stub> getConnection() {
    std::unique_lock<std::mutex> lock(mutex_);
    cond_.wait(lock, [this] {
        if (b_stop_) {
            return true;
        }
        return !connections_.empty();
        });
    //å¦‚æœåœæ­¢åˆ™ç›´æ¥è¿”å›ç©ºæŒ‡é’ˆ
    if (b_stop_) {
        return  nullptr;
    }
    auto context = std::move(connections_.front());
    connections_.pop();
    return context;
}

void returnConnection(std::unique_ptr<VarifyService::Stub> context) {
    std::lock_guard<std::mutex> lock(mutex_);
    if (b_stop_) {
        return;
    }
    connections_.push(std::move(context));
    cond_.notify_one();
}

void Close() {
    b_stop_ = true;
    cond_.notify_all();
}

private:
    atomic<bool> b_stop_;
    size_t poolSize_;
    std::string host_;
    std::string port_;
    std::queue<std::unique_ptr<VarifyService::Stub>> connections_;
    std::mutex mutex_;
    std::condition_variable cond_;
};


```

